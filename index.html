    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Equipos con Firebase</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #0056b3;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h2 {
            color: #0056b3;
            margin-top: 0;
        }
        
        /* --- Contenedor de Login --- */
        #login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        #login-container h2 {
            text-align: center;
            border: none;
        }

        .login-form-group {
            margin-bottom: 15px;
        }
        
        .login-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .login-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        #login-buttons {
            display: flex;
            margin-top: 20px;
        }
        
        .auth-btn {
            width: 100%; /* El botón ocupa todo el ancho */
            padding: 12px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #login-btn { background-color: #007bff; }
        #login-btn:hover { background-color: #0056b3; }
        
        #auth-error {
            color: #dc3545;
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
        }

        /* Contenedor de la App (se oculta al inicio) */
        #app-container {
            display: none;
        }
        
        #logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* --- Formulario --- */
        #form-container {
            margin-bottom: 30px;
        }
        
        #form-container h2 {
             border-bottom: 2px solid #e0e0e0;
             padding-bottom: 10px;
        }

        #inventory-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group select,
        .form-group input[type="file"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group input[type="file"] {
            padding: 7px;
        }
        
        #foto-hint {
            font-size: 0.9em;
            color: #666;
            display: none;
            margin-top: 5px;
        }

        #submit-btn {
            grid-column: 1 / -1; 
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        /* --- Encabezado de la Lista --- */
        .list-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .list-header h2 {
            border: none;
            padding: 0;
            margin: 0;
        }
        
        .export-import-buttons {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: background-color 0.3s ease;
        }
        
        #export-csv-btn { background-color: #28a745; }
        #export-csv-btn:hover { background-color: #218838; }
        
        #backup-json-btn { background-color: #17a2b8; }
        #backup-json-btn:hover { background-color: #138496; }
        
        #import-json-btn { background-color: #ffc107; color: #333; }
        #import-json-btn:hover { background-color: #e0a800; }
        
        /* --- Tabla de Inventario --- */
        #list-container {
            overflow-x: auto; 
        }

        #inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0; 
        }

        #inventory-table th,
        #inventory-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        #inventory-table th {
            background-color: #f2f2f2;
            font-weight: 700;
        }

        #inventory-table img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .action-btn {
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
        }
        .action-btn.edit { background-color: #007bff; }
        .action-btn.edit:hover { background-color: #0056b3; }
        .action-btn.delete { background-color: #dc3545; }
        .action-btn.delete:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <div id="login-container">
        <h2>Inventario de Equipos</h2>
        <div class="login-form-group">
            <label for="email">Correo Electrónico:</label>
            <input type="email" id="email" required>
        </div>
        <div class="login-form-group">
            <label for="password">Contraseña:</label>
            <input type="password" id="password" required>
        </div>
        <div id="login-buttons">
            <button id="login-btn" class="auth-btn">Iniciar Sesión</button>
        </div>
        <p id="auth-error"></p>
    </div>

    <div class="container" id="app-container">
        <h1>
            <span>Inventario de Equipos (PC/Laptops)</span>
            <button id="logout-btn">Cerrar Sesión</button>
        </h1>

        <div id="form-container">
            <h2>Registrar Nuevo Equipo</h2>
            <form id="inventory-form">
                <div class="form-group">
                    <label for="marca">Marca:</label>
                    <input type="text" id="marca" required>
                </div>
                <div class="form-group">
                    <label for="modelo">Modelo:</label>
                    <input type="text" id="modelo" required>
                </div>
                <div class="form-group">
                    <label for="serial">Serial:</label>
                    <input type="text" id="serial" required>
                </div>
                <div class="form-group">
                    <label for="so">Sistema Operativo:</label>
                    <select id="so" required>
                        <option value="">Seleccione...</option>
                        <option value="Windows 11">Windows 11</option>
                        <option value="Windows 10">Windows 10</option>
                        <option value="Windows 7">Windows 7</option>
                        <option value="macOS">macOS</option>
                        <option value="Linux (Ubuntu)">Linux (Ubuntu)</option>
                        <option value="Linux (Otro)">Linux (Otro)</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="nombreEquipo">Nombre del Equipo:</label>
                    <input type="text" id="nombreEquipo" required>
                </div>
                <div class="form-group">
                    <label for="usuarioAsignado">Usuario Asignado:</label>
                    <input type="text" id="usuarioAsignado">
                </div>
                <div class="form-group">
                    <label for="departamento">Departamento:</label>
                    <input type="text" id="departamento">
                </div>
                <div class="form-group">
                    <label for="foto">Foto del Equipo:</label>
                    <input type="file" id="foto" accept="image/*">
                    <span id="foto-hint">Foto cargada. Reemplace solo si desea cambiarla.</span>
                </div>

                <button type="submit" id="submit-btn">Agregar al Inventario</button>
            </form>
        </div>

        <div id="list-container">
            
            <div class="list-header">
                <h2>Equipos Registrados</h2>
                <div class="export-import-buttons">
                    <button id="export-csv-btn" class="header-btn">Exportar CSV</button>
                    <button id="backup-json-btn" class="header-btn">Respaldar JSON</button>
                    <button id="import-json-btn" class="header-btn">Importar JSON</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                </div>
            </div>
            
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th>Foto</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Serial</th>
                        <th>S.O.</th>
                        <th>Nombre Equipo</th>
                        <th>Usuario</th>
                        <th>Departamento</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body">
                    </tbody>
            </table>
        </div>

    </div> <script type="module">
        // Importa las funciones de los SDKs de Firebase desde la CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            onValue, 
            push, 
            remove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Tu configuración de Firebase que proporcionaste
        const firebaseConfig = {
            apiKey: "AIzaSyDdEUFP1WRTIcCHhZwFWKMSxqqVi4yVLFo",
            authDomain: "inventario-2e323.firebaseapp.com",
            projectId: "inventario-2e323",
            storageBucket: "inventario-2e323.firebasestorage.app",
            messagingSenderId: "737250244614",
            appId: "1:737250244614:web:8b991b913a99a4b0a46b87"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Referencias a Elementos del DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const authError = document.getElementById('auth-error');
        
        const loginBtn = document.getElementById('login-btn');
        // const registerBtn = document.getElementById('register-btn'); // ELIMINADO
        const logoutBtn = document.getElementById('logout-btn');
        
        const form = document.getElementById('inventory-form');
        const submitBtn = document.getElementById('submit-btn');
        const tableBody = document.getElementById('inventory-table-body');
        const fotoInput = document.getElementById('foto');
        const fotoHint = document.getElementById('foto-hint');
        
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const backupJsonBtn = document.getElementById('backup-json-btn');
        const importJsonBtn = document.getElementById('import-json-btn');
        const importFileInput = document.getElementById('import-file');

        // --- Variables de Estado Global (dentro del módulo) ---
        let currentUser = null;
        let userInventoryRef = null;
        let currentInventoryData = {};
        let editKey = null;

        // --- 1. LÓGICA DE AUTENTICACIÓN ---

        // Observador del estado de autenticación (el controlador principal)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario ha iniciado sesión
                currentUser = user;
                userInventoryRef = ref(db, 'inventario/' + user.uid);
                
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                authError.textContent = '';
                
                startDatabaseListener();
            } else {
                // Usuario ha cerrado sesión
                currentUser = null;
                userInventoryRef = null;
                
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                tableBody.innerHTML = '';
                currentInventoryData = {};
            }
        });

        // Iniciar Sesión
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    authError.textContent = getAuthErrorMessage(error.code);
                });
        });

        // Cerrar Sesión
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- 2. LÓGICA DE BASE DE DATOS (CRUD) ---

        function startDatabaseListener() {
            if (!userInventoryRef) return;
            
            onValue(userInventoryRef, (snapshot) => {
                const data = snapshot.val();
                currentInventoryData = data || {};
                renderTable(currentInventoryData);
            });
        }

        function renderTable(data) {
            tableBody.innerHTML = ''; 

            if (Object.keys(data).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No hay equipos registrados.</td></tr>';
                return;
            }

            for (const key in data) {
                const item = data[key];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <img src="${item.fotoBase64 || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="Foto de ${item.modelo}">
                    </td>
                    <td>${escapeHTML(item.marca)}</td>
                    <td>${escapeHTML(item.modelo)}</td>
                    <td>${escapeHTML(item.serial)}</td>
                    <td>${escapeHTML(item.so)}</td>
                    <td>${escapeHTML(item.nombreEquipo)}</td>
                    <td>${escapeHTML(item.usuarioAsignado)}</td>
                    <td>${escapeHTML(item.departamento)}</td>
                    <td>
                        <button class="action-btn edit" data-key="${key}">Editar</button>
                        <button class="action-btn delete" data-key="${key}">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault(); 
            if (!currentUser) return;

            const file = fotoInput.files[0];
            
            const processSave = (newFotoBase64) => {
                const dataFromForm = {
                    marca: document.getElementById('marca').value,
                    modelo: document.getElementById('modelo').value,
                    serial: document.getElementById('serial').value,
                    so: document.getElementById('so').value,
                    nombreEquipo: document.getElementById('nombreEquipo').value,
                    usuarioAsignado: document.getElementById('usuarioAsignado').value,
                    departamento: document.getElementById('departamento').value,
                };

                if (editKey) {
                    // --- MODO EDICIÓN (Actualizar) ---
                    const oldItem = currentInventoryData[editKey];
                    dataFromForm.fotoBase64 = newFotoBase64 === null ? oldItem.fotoBase64 : newFotoBase64;
                    
                    const itemRef = ref(db, `inventario/${currentUser.uid}/${editKey}`);
                    set(itemRef, dataFromForm);
                    
                } else {
                    // --- MODO AGREGAR (Crear) ---
                    dataFromForm.fotoBase64 = newFotoBase64;
                    
                    const newItemRef = push(userInventoryRef);
                    set(newItemRef, dataFromForm);
                }
                
                resetForm();
            };

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => processSave(reader.result);
                reader.readAsDataURL(file);
            } else {
                processSave(null);
            }
        });

        tableBody.addEventListener('click', (e) => {
            const target = e.target;
            const key = target.dataset.key;
            
            if (!key) return;

            if (target.classList.contains('edit')) {
                loadItemForEdit(key);
            }
            
            if (target.classList.contains('delete')) {
                const itemModelo = currentInventoryData[key]?.modelo || 'el equipo';
                if (confirm(`¿Está seguro de que desea eliminar ${itemModelo}?`)) {
                    deleteItem(key);
                }
            }
        });

        function loadItemForEdit(key) {
            const item = currentInventoryData[key];
            if (!item) return;
            
            document.getElementById('marca').value = item.marca;
            document.getElementById('modelo').value = item.modelo;
            document.getElementById('serial').value = item.serial;
            document.getElementById('so').value = item.so;
            document.getElementById('nombreEquipo').value = item.nombreEquipo;
            document.getElementById('usuarioAsignado').value = item.usuarioAsignado;
            document.getElementById('departamento').value = item.departamento;
            
            editKey = key;
            submitBtn.textContent = 'Guardar Cambios';
            fotoHint.style.display = 'block';

            form.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteItem(key) {
            if (!currentUser) return;
            
            const itemRef = ref(db, `inventario/${currentUser.uid}/${key}`);
            remove(itemRef);
            
            if (editKey === key) {
                resetForm();
            }
        }
        
        function resetForm() {
            form.reset();
            editKey = null;
            submitBtn.textContent = 'Agregar al Inventario';
            fotoHint.style.display = 'none';
        }

        // --- 3. LÓGICA DE IMPORTACIÓN / EXPORTACIÓN ---
        
        // Exportar a CSV
        exportCsvBtn.addEventListener('click', () => {
            const inventory = Object.values(currentInventoryData);
            if (inventory.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            
            const headers = ['Marca', 'Modelo', 'Serial', 'Sistema Operativo', 'Nombre del Equipo', 'Usuario Asignado', 'Departamento'];
            const keys = ['marca', 'modelo', 'serial', 'so', 'nombreEquipo', 'usuarioAsignado', 'departamento'];
            
            let csvContent = [headers.map(escapeCSV).join(',')];
            inventory.forEach(item => {
                const row = keys.map(key => escapeCSV(item[key]));
                csvContent.push(row.join(','));
            });
            
            downloadFile(csvContent.join('\r\n'), 'inventario_equipos.csv', 'text/csv;charset=utf-8;');
        });

        // Respaldar a JSON
        backupJsonBtn.addEventListener('click', () => {
            if (Object.keys(currentInventoryData).length === 0) {
                alert('No hay datos para respaldar.');
                return;
            }
            
            const jsonString = JSON.stringify(currentInventoryData, null, 2);
            downloadFile(jsonString, 'inventario_backup.json', 'application/json;charset=utf-8;');
        });
        
        // Importar desde JSON
        importJsonBtn.addEventListener('click', () => {
            importFileInput.click();
        });
        
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !currentUser) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm("ADVERTENCIA:\nEsto reemplazará TODO el inventario actual en la nube con el contenido de este archivo.\n\n¿Desea continuar?")) {
                        set(userInventoryRef, importedData)
                            .then(() => {
                                alert('Importación completada exitosamente. La tabla se actualizará automáticamente.');
                            })
                            .catch((error) => {
                                alert('Error al importar: ' + error.message);
                            });
                    }
                } catch (error) {
                    alert('Error: El archivo seleccionado no es un JSON válido.');
                } finally {
                    importFileInput.value = null;
                }
            };
            reader.readAsText(file);
        });

        // --- 4. FUNCIONES DE UTILIDAD ---

        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/wrong-password':
                    return 'Contraseña incorrecta.';
                case 'auth/user-not-found':
                    return 'Usuario no encontrado.';
                case 'auth/invalid-email':
                    return 'El formato del correo electrónico es inválido.';
                default:
                    return 'Error de autenticación: ' + code;
            }
        }
        
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"']/g, (match) => {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return map[match];
            });
        }
        
        function escapeCSV(val) {
            if (val === null || val === undefined) return '""'; 
            let str = String(val);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str; 
        }
        
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

    </script>

</body>
</html>


